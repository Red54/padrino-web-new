<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="initial-scale=1" name="viewport" /><title>Padrino - Padrino and OmniAuth Overview</title><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" /><link href="../../assets/stylesheets/style-75d468d0.css" rel="stylesheet" /></head><body class="blog blog_padrino-and-omniauth-overview blog_padrino-and-omniauth-overview_index"><div class="grid"><header class="header"><h1 class="header__name"><a class="padrino-name" href="/">Padrino</a></h1><div class="header__navigation"><nav class="navigation"><a class="navigation__toggler" href="#" id="navigation__toggler"><span class="navigation__toggler__icon fa fa-navicon"></span></a><ul class="navigation__items" id="navigation__items"><li class="navigation__item"><a class="navigation__link" href="/">Overview</a></li><li class="navigation__item"><a class="navigation__link" href="/guides/">Guides</a></li><li class="navigation__item"><a class="navigation__link" href="http://www.rubydoc.info/github/padrino/padrino-framework">API</a></li><li class="navigation__item"><a class="navigation__link" href="/contribute/">Contribute</a></li><li class="navigation__item"><a class="navigation__link--is-active" href="/blog/">Blog</a></li><li class="navigation__item"><a class="navigation__link" href="https://github.com/padrino/padrino-framework"><span class="button--slim">GitHub</span></a></li></ul></nav></div></header><div class="page"><div class="page__sidebar"><div class="sidebar"><h4 class="sidebar__header--first">Blog</h4><h5 class="sidebar__header">Latest Posts</h5><ul class="sidebar__items"><li class="sidebar__item"><a class="sidebar__link" href="/blog/padrino-0-12-5/">Padrino 0.12.5</a></li><li class="sidebar__item"><a class="sidebar__link" href="/blog/padrino-0-12-4/">Padrino 0.12.4</a></li><li class="sidebar__item"><a class="sidebar__link" href="/blog/padrino-0-11-0-released-padrino-lives/">Padrino 0.11.0 Released - Padrino Lives!</a></li><li class="sidebar__item"><a class="sidebar__link" href="/blog/json-gem-vulnerability/">JSON gem vulnerability</a></li><li class="sidebar__item"><a class="sidebar__link" href="/blog/upgrade-rack-immediately/">Upgrade Rack immediately</a></li></ul></div></div><div class="page__content"><div class="content"><div class="article"><h1 class="article__title">Padrino and OmniAuth Overview</h1><p class="article__metadata">Posted on May 10, 2011 by DAddYE</p><p>In this post, we will show you how to mix our <a href="https://github.com/padrino/padrino-framework/blob/master/padrino-admin/lib/padrino-admin/access_control.rb">Access Control</a> described <a href="/guides/padrino-admin#admin-authentication">here</a> with the beautiful <a href="https://github.com/intridea/omniauth">omniauth</a> rack middleware.</p>

<p>The Padrino admin authentication and access control system provides a simple foundation from which you can create your authentication system. Combined with <a href="https://github.com/intridea/omniauth">omniauth</a> you can then easily leverage the system to allow authentication through a variety of methods. Read below for more details on how to integrate them.</p>

<p>In this article we’ll cover two topics:</p>

<p>1) Integrating Padrino Admin Authentication into all apps within your project
 2) Enabling custom authentication strategies within the authentication system</p>

<p>Before we begin, it is important to note that our integrated authentication based on project-roles can interact easily with other systems. The only files that need to be changed are <code>session.rb</code> and <code>account.rb</code> in order to add your own custom code.</p>

<p>So, let’s start by creating a project using activerecord:</p>

<pre class="highlight plaintext"><code>$ padrino g project foo --orm activerecord --tiny
$ cd foo
$ bundle install
</code></pre>

<p>Now we need to add a model called <code>Account</code> to act as our persistence model:</p>

<pre class="highlight plaintext"><code>$ padrino g model Account name:string email:string role:string uid:string provider:string
</code></pre>

<table>
  <tbody>
    <tr>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>name</td>
      <td>the name of the account</td>
    </tr>
    <tr>
      <td>email</td>
      <td>the email of the account</td>
    </tr>
    <tr>
      <td>role</td>
      <td>the access control role</td>
    </tr>
    <tr>
      <td>uid</td>
      <td>omniauth uid</td>
    </tr>
    <tr>
      <td>provider</td>
      <td>omniauth provider</td>
    </tr>
  </tbody>
</table>

<p>Now we need to create and migrate our database:</p>

<pre class="highlight plaintext"><code>$ padrino rake ar:create ar:migrate
</code></pre>

<p>Open your favorite editor and browse and edit <code>Gemfile</code> and add <code>omniauth</code> gem and the providers for twitter and facebook.
We also add the <code>haml</code> gem as it's not included by default in the "tiny" padrino template:</p>

<pre class="highlight plaintext"><code># Gemfile
gem 'omniauth'
gem 'omniauth-twitter'
gem 'omniauth-facebook'
gem 'haml'
</code></pre>

<p>Now, run bundle install to install dependencies:</p>

<pre class="highlight plaintext"><code>$ bundle install
</code></pre>

<p>Now we need to add the <code>omniauth middleware</code>. Here you can choose two ways:</p>

<p>1) Add the middleware project-wide (so every subapp can use it)
 2) Add the middleware only to the one app that requires it</p>

<p>In our example, we need to edit simply <code>app/app.rb</code> and add:</p>

<pre class="highlight plaintext"><code># app/app.rb
use OmniAuth::Builder do
  provider :twitter,  'consumer_key', 'consumer_secret'
  provider :facebook, 'app_id', 'app_secret'
end
</code></pre>

<p>If you are in a multiapp scenario you need to edit <code>config/boot.rb</code>:</p>

<pre class="highlight plaintext"><code># config/boot.rb
Padrino.use OmniAuth::Builder do
  provider :twitter,  'consumer_key', 'consumer_secret'
  provider :facebook, 'app_id', 'app_secret'
end

# before the line
Padrino.load!
</code></pre>

<p>To obtain an app_id and secret for Facebook, you need to:</p>

<ul>
  <li>Go to the <a href="http://www.facebook.com/developers">Facebook Developers Page</a></li>
  <li>Browse and click <a href="http://www.facebook.com/developers/createapp.php">create a new app</a></li>
  <li>Set your app name and complete the form…</li>
  <li>One you finish that you are allowed to edit your settings, go to <strong>website</strong> section</li>
  <li>Add to site url: <code>http://localhost:3000</code></li>
  <li>Add to domain: <code>localhost</code></li>
  <li>Write the <strong>Application ID</strong> and <strong>Application Secret</strong> to the <code>OmniAuth::Builder</code></li>
</ul>

<p>To obtain a consumer_key and consumer_secret for Twitter, you need to:</p>

<ul>
  <li>Go to <a href="https://developer.twitter.com/apps/new">Twitter Applications Page</a></li>
  <li>Insert all details and be sure to check <strong>Application Type: Browser</strong></li>
  <li>Set a callback url with a valid domain ex: <code>www.mydomain.com/auth/twitter/callback</code></li>
  <li>Save and go to <strong>Application Settings</strong> and <strong>Manage Domains</strong></li>
  <li>Be sure that you can see your example domain: <code>www.mydomain.com/auth/twitter/callback</code></li>
  <li>Authorize domain: <code>localhost</code></li>
  <li>Now go to <strong>Application Details</strong> and save <code>Consumer key</code> and <code>Consumer Secret</code> to the <code>OmniAuth::Builder</code></li>
</ul>

<p><strong>NOTE</strong>: For domain, it is not important that this path exist because <code>omniauth</code> changes the callback url.</p>

<p>Next, we can integrate our authentication system within in <code>app/app.rb</code>:</p>

<pre class="highlight plaintext"><code># app/app.rb
# at the top before the class definition
register Padrino::Admin::AccessControl

set :login_page, "/" # determines the url login occurs

access_control.roles_for :any do |role|
  role.protect "/profile"
  role.protect "/admin" # here a demo path
end

# now we add a role for users
access_control.roles_for :users do |role|
  role.allow "/profile"
end
</code></pre>

<p>And add a couple useful routes, edit <code>app/controllers.rb</code> with:</p>

<pre class="highlight plaintext"><code># app/controllers.rb
get :index do
  haml &lt;&lt;-HAML.gsub(/^ {6}/, '')
    Login with
    =link_to('Facebook', '/auth/facebook')
    or
    =link_to('Twitter',  '/auth/twitter')
  HAML
end

get :profile do
  content_type :text
  current_account.to_yaml
end

get :destroy do
  set_current_account(nil)
  redirect url(:index)
end

get :auth, :map =&gt; '/auth/:provider/callback' do
  auth    = request.env["omniauth.auth"]
  account = Account.find_by_provider_and_uid(auth["provider"], auth["uid"]) ||
            Account.create_with_omniauth(auth)
  set_current_account(account)
  redirect "http://" + request.env["HTTP_HOST"] + url(:profile)
end
</code></pre>

<p>We invoked a method <code>Account.create_with_omniauth</code> above, so edit <code>app/models/account.rb</code> and add:</p>

<pre class="highlight plaintext"><code># app/models/account.rb
def self.create_with_omniauth(auth)
  create! do |account|
    account.provider = auth["provider"]
    account.uid      = auth["uid"]
    account.email    = auth["name"]
    account.email    = auth["user_info"]["email"] if auth["user_info"] # we get this only from FB
    account.role     = "users"
  end
end
</code></pre>

<p>That should just about do it! Let’s start the server:</p>

<pre class="highlight plaintext"><code>$ padrino start
</code></pre>

<p>Browse <a href="http://localhost:3000/profile">http://localhost:3000/profile</a></p>

<p>That will kickoff to the login_page, in our case <code>/</code>.</p>

<p>Now you can login here <a href="http://localhost:3000">http://localhost:3000</a></p>

<p>Follow your login process and then if needed <a href="http://localhost:3000/destroy">http://localhost:3000/destroy</a></p>

<p>That is all you need to setup a barebones authentication system in Padrino. This post has gotten you started with a working “Account” and role based authentication solution with integrated omniauth support. From here, obviously there are a number of other features you might want to add on top to flesh out, and that is left for another post or as an exercise to the reader.</p>

<p>If you are interested in more Padrino information, check out <a href="http://www.padrinorb.com/pages/why">why you should use</a> our framework and our <a href="http://www.padrinorb.com/guides/blog-tutorial">Blog Tutorial</a> along with our other <a href="http://www.padrinorb.com/guides">Padrino Guides</a>.</p>
<hr /><div id="disqus_thread"></div></div></div></div></div><hr /><footer class="footer"><p>Padrino is released under the MIT LICENSE<br />
Hosting by <a href="https://pages.github.com">GitHub Pages</a></p>
</footer><script src="../../assets/javascripts/all-c2e0cecd.js"></script></div><script src="https://padrinorb.disqus.com/embed.js"></script></body></html>